name: Publish Apps

on:
  push:
    tags:
      - "v*"

jobs:
  publish-frontend-solid:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.1"

      - name: Install dependencies
        run: bun install --frozen-lockfile
        working-directory: ./frontend-solid

      - name: Build frontend
        run: bun run build
        working-directory: ./frontend-solid

      - name: Prepare frontend release bundle
        run: |
          mkdir -p ./publish/frontend-solid
          cp -r ./frontend-solid/dist ./publish/frontend-solid/dist
          cp ./frontend-solid/server.ts ./publish/frontend-solid/server.ts
          cp ./frontend-solid/package.json ./publish/frontend-solid/package.json
          cp ./frontend-solid/bun.lock ./publish/frontend-solid/bun.lock
          cp ./frontend-solid/README.md ./publish/frontend-solid/README.md

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: mediaflick-frontend-solid
          path: ./publish/frontend-solid

  publish-backend-bun:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.1"

      - name: Install dependencies
        run: bun install --frozen-lockfile
        working-directory: ./backend-bun

      - name: Typecheck backend
        run: bun run typecheck
        working-directory: ./backend-bun

      - name: Prepare backend release bundle
        run: |
          mkdir -p ./publish/backend-bun
          mkdir -p ./publish/backend-bun/config
          cp -r ./backend-bun/src ./publish/backend-bun/src
          cp ./backend-bun/config/config.yml ./publish/backend-bun/config/config.yml
          cp -r ./backend-bun/docs ./publish/backend-bun/docs
          cp ./backend-bun/package.json ./publish/backend-bun/package.json
          cp ./backend-bun/bun.lock ./publish/backend-bun/bun.lock
          cp ./backend-bun/tsconfig.json ./publish/backend-bun/tsconfig.json
          cp ./backend-bun/drizzle.config.ts ./publish/backend-bun/drizzle.config.ts
          cp ./backend-bun/README.md ./publish/backend-bun/README.md

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: mediaflick-backend-bun
          path: ./publish/backend-bun

  create-release:
    needs: [publish-frontend-solid, publish-backend-bun]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create release archives
        run: |
          cd ./artifacts
          tar -czf mediaflick-frontend-solid.tar.gz mediaflick-frontend-solid
          tar -czf mediaflick-backend-bun.tar.gz mediaflick-backend-bun

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/mediaflick-frontend-solid.tar.gz
            artifacts/mediaflick-backend-bun.tar.gz
